<!--pages/checkout/index.wxml-->
<view class="checkout-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">æ­£åœ¨åŠ è½½è®¢å•ä¿¡æ¯...</text>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:elif="{{error}}" class="error-container">
    <view class="error-icon">âš ï¸</view>
    <text class="error-message">{{error}}</text>
    <button class="retry-button" bindtap="onRetry">é‡è¯•</button>
  </view>

  <!-- æ­£å¸¸å†…å®¹ -->
  <view wx:else class="checkout-content">
    <!-- æ”¶è´§åœ°å€ -->
    <view class="address-section">
      <view class="section-header">
        <text class="section-title">æ”¶è´§åœ°å€</text>
      </view>
      <view class="address-card" bindtap="onAddressSelect">
        <view wx:if="{{selectedAddress}}" class="address-content">
          <view class="address-info">
            <text class="recipient-name">{{selectedAddress.name}}</text>
            <text class="recipient-phone">{{selectedAddress.phone}}</text>
          </view>
          <text class="address-detail">{{selectedAddress.address}}</text>
        </view>
        <view wx:else class="no-address">
          <text class="no-address-text">è¯·é€‰æ‹©æ”¶è´§åœ°å€</text>
        </view>
        <text class="address-arrow">></text>
      </view>
    </view>

    <!-- å•†å“åˆ—è¡¨ -->
    <view class="products-section">
      <view class="section-header">
        <text class="section-title">å•†å“æ¸…å•</text>
        <text class="product-count">å…±{{checkoutItems.length}}ä»¶</text>
      </view>
      <view class="product-list">
        <view wx:for="{{checkoutItems}}" wx:key="productId" class="product-item">
          <image class="product-image" src="{{item.product.image}}" mode="aspectFill"></image>
          <view class="product-info">
            <text class="product-name">{{item.product.name}}</text>
            <text class="product-spec">è§„æ ¼ï¼šé»˜è®¤</text>
            <view class="product-price-quantity">
              <text class="product-price">Â¥{{item.product.discountedPrice || item.product.originalPrice}}</text>
              <text class="product-quantity">Ã—{{item.quantity}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- é…é€æ–¹å¼ -->
    <view class="delivery-section">
      <view class="section-header">
        <text class="section-title">é…é€æ–¹å¼</text>
      </view>
      <view class="delivery-options">
        <view class="delivery-option selected">
          <text class="delivery-name">æ ‡å‡†é…é€</text>
          <text class="delivery-desc">é¢„è®¡3-5å¤©é€è¾¾</text>
          <text class="delivery-fee">å…è¿è´¹</text>
        </view>
      </view>
    </view>

    <!-- æ”¯ä»˜æ–¹å¼ -->
    <view class="payment-section">
      <view class="section-header">
        <text class="section-title">æ”¯ä»˜æ–¹å¼</text>
      </view>
      <view class="payment-options">
        <view class="payment-option selected">
          <text class="payment-name">å¾®ä¿¡æ”¯ä»˜</text>
          <text class="payment-icon">ğŸ’³</text>
        </view>
      </view>
    </view>

    <!-- è®¢å•å¤‡æ³¨ -->
    <view class="note-section">
      <view class="section-header">
        <text class="section-title">è®¢å•å¤‡æ³¨</text>
      </view>
      <textarea 
        class="note-input" 
        placeholder="é€‰å¡«ï¼Œè¯·è¾“å…¥è®¢å•å¤‡æ³¨" 
        value="{{orderNote}}"
        bindinput="onNoteInput"
        maxlength="200">
      </textarea>
    </view>

    <!-- ä¼˜æƒ åˆ¸ -->
    <view class="coupon-section" bindtap="onCouponSelect">
      <view class="coupon-content">
        <text class="coupon-title">ä¼˜æƒ åˆ¸</text>
        <view class="coupon-info">
          <text wx:if="{{selectedCoupon}}" class="coupon-selected">
            å·²é€‰æ‹©ï¼š{{selectedCoupon.name}}
          </text>
          <text wx:else class="coupon-none">æš‚æ— å¯ç”¨ä¼˜æƒ åˆ¸</text>
          <text class="coupon-arrow">></text>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨ç»“ç®—æ  -->
  <view class="checkout-bottom">
    <view class="price-summary">
      <view class="price-row">
        <text class="price-label">å•†å“æ€»ä»·</text>
        <text class="price-value">Â¥{{summary.totalPrice.toFixed(2)}}</text>
      </view>
      <view wx:if="{{summary.discountAmount > 0}}" class="price-row discount">
        <text class="price-label">ä¼˜æƒ </text>
        <text class="price-value">-Â¥{{summary.discountAmount.toFixed(2)}}</text>
      </view>
      <view class="price-row total">
        <text class="price-label">å®ä»˜æ¬¾</text>
        <text class="price-value final">Â¥{{summary.finalPrice.toFixed(2)}}</text>
      </view>
    </view>
    <button 
      class="submit-order-button {{!canSubmit ? 'disabled' : ''}}" 
      bindtap="onSubmitOrder"
      disabled="{{!canSubmit}}">
      {{submitButtonText}}
    </button>
  </view>
</view>

<!-- åº“å­˜ä¸è¶³æç¤ºå¼¹çª— -->
<view wx:if="{{showStockAlert}}" class="stock-alert-overlay" bindtap="onCloseStockAlert">
  <view class="stock-alert-modal" catchtap="">
    <view class="alert-header">
      <text class="alert-title">åº“å­˜ä¸è¶³</text>
    </view>
    <view class="alert-content">
      <text class="alert-message">ä»¥ä¸‹å•†å“åº“å­˜ä¸è¶³ï¼Œè¯·è¿”å›è´­ç‰©è½¦è°ƒæ•´æ•°é‡ï¼š</text>
      <view class="stock-error-list">
        <view wx:for="{{stockErrors}}" wx:key="productId" class="stock-error-item">
          <text class="error-product-name">{{item.productName}}</text>
          <text class="error-stock-info">åº“å­˜ï¼š{{item.availableStock}}ï¼Œéœ€è¦ï¼š{{item.requestedQuantity}}</text>
        </view>
      </view>
    </view>
    <view class="alert-actions">
      <button class="alert-button cancel" bindtap="onCloseStockAlert">å–æ¶ˆ</button>
      <button class="alert-button confirm" bindtap="onBackToCart">è¿”å›è´­ç‰©è½¦</button>
    </view>
  </view>
</view>